name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Verify dependencies
        run: go mod verify
      
      - name: Download dependencies
        run: go mod download
      
      - name: Build with version info
        run: |
          # Build with version from git tags (if available) or use "dev"
          VERSION=$(git describe --tags --always 2>/dev/null || echo "dev")
          COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          go build -ldflags "-X github.com/hugoev/zap/internal/version.Version=${VERSION} -X github.com/hugoev/zap/internal/version.Commit=${COMMIT} -X github.com/hugoev/zap/internal/version.Date=${DATE}" ./cmd/zap
          
          echo "âœ… Built with version: ${VERSION}"
      
      - name: Verify version works
        run: |
          # Test that version command works
          ./zap version || go run -ldflags "-X github.com/hugoev/zap/internal/version.Version=dev" ./cmd/zap version

